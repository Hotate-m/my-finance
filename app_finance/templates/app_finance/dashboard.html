{% extends "app_finance/base.html" %}

{% block title %}Dashboard ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
  <div>
    <h1 class="h3 mb-1">Dashboard ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h1>
    <div class="text-secondary" style="font-size:13px;">
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ today|date:"j F Y" }}
    </div>
  </div>
  <div class="d-flex flex-wrap gap-2 align-items-center">
    <a href="{% url 'app_finance:transaction_create' %}?type=IN" class="btn btn-brand btn-sm">
      + ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
    </a>
    <a href="{% url 'app_finance:transaction_create' %}?type=OUT" class="btn btn-ghost btn-sm">
      + ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
    </a>
    <a href="{% url 'app_finance:transactions_list' %}" class="btn btn-ghost btn-sm">
      ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </a>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ü‡∏∑‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dashboard -->
    <!-- <a href="{% url 'app_finance:dashboard_preferences' %}"
      class="btn btn-ghost btn-sm rounded-circle d-flex align-items-center justify-content-center"
      style="width:36px;height:36px;"
      title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Dashboard / ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠">
      ‚öôÔ∏è
    </a> -->
  </div>
</div>

<!-- Net Worth summary -->
<div class="card-soft-ghost p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <div class="fw-semibold">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏° (Net Worth)</div>
      <div class="text-secondary" style="font-size:12px;">
        ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏£‡∏ß‡∏° - ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏° ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
      </div>
    </div>
    <span class="badge-chip">Net Worth</span>
  </div>
  <div class="row g-3">
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏£‡∏ß‡∏°</div>
      <div class="fw-semibold text-success" style="font-size:18px;">
        ‡∏ø{{ total_assets|floatformat:2 }}
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
      <div class="fw-semibold text-danger" style="font-size:18px;">
        ‡∏ø{{ total_liabilities|floatformat:2 }}
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Worth)</div>
      <div class="fw-semibold"
           style="font-size:18px;
             {% if net_worth > 0 %}
               color:#22c55e;
             {% elif net_worth < 0 %}
               color:#f97373;
             {% else %}
               color:#e5e7eb;
             {% endif %}
           ">
        ‡∏ø{{ net_worth|floatformat:2 }}
      </div>
    </div>
  </div>
</div>

{% if not dash_pref or dash_pref.show_smart_insights %}
<!-- Smart Insight -->
<div class="card-soft-ghost p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <div class="fw-semibold">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏â‡∏•‡∏≤‡∏î ‡πÜ ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="text-secondary" style="font-size:12px;">
        ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏≠‡∏î‡∏µ‡∏ï
      </div>
    </div>
    <span class="badge-chip">Insights</span>
  </div>

  <div class="row g-3">
    <div class="col-12 col-md-6">
      <div class="text-secondary" style="font-size:12px;">‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      {% if insight_top_category_name %}
        <div class="fw-semibold" style="font-size:14px;">
          {{ insight_top_category_name }}
        </div>
        <div class="text-danger" style="font-size:13px;">
          ‡∏ø{{ insight_top_category_amount|floatformat:2 }}
        </div>
      {% else %}
        <div class="text-secondary" style="font-size:13px;">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        </div>
      {% endif %}
    </div>

    <div class="col-12 col-md-6">
      <div class="text-secondary" style="font-size:12px;">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>
      {% if avg_exp_prev is not None and avg_exp_prev > 0 %}
        <div style="font-size:13px;">
          {% if insight_expense_higher %}
            <span class="text-danger">
              ‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
              ‡∏ø{{ insight_expense_vs_avg|floatformat:2 }}
              ({{ insight_expense_vs_avg_percent|floatformat:1 }}%)
            </span>
          {% else %}
            <span class="text-success">
              ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
              ‡∏ø{{ insight_expense_vs_avg|floatformat:2|cut:"-" }}
              ({{ insight_expense_vs_avg_percent|floatformat:1|cut:"-" }}%)
            </span>
          {% endif %}
        </div>
        <div class="text-secondary" style="font-size:11px;">
          ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô: ‡∏ø{{ avg_exp_prev|floatformat:2 }}
        </div>
      {% else %}
        <div class="text-secondary" style="font-size:13px;">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

{% if not dash_pref or dash_pref.show_budget_box %}
<!-- ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏à‡∏≤‡∏Å‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ -->
<div class="card-soft-ghost p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <div class="fw-semibold">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="text-secondary" style="font-size:12px;">
        ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏±‡∏ö‡∏á‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î ¬∑ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: {{ today|date:"m/Y" }}
      </div>
    </div>
    <a href="{% url 'app_finance:budgets_overview' %}" class="badge-chip">
      ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ö
    </a>
  </div>

  {% if budget_total_count == 0 %}
    <div class="text-secondary" style="font-size:13px;">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ  
      ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π ‚Äú‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‚Üí ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‚Äù ‡∏´‡∏£‡∏∑‡∏≠ Django admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏±‡∏ö
    </div>
  {% else %}
    <div class="mb-2" style="font-size:13px;">
      ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡πÑ‡∏ß‡πâ {{ budget_total_count }} ‡∏´‡∏°‡∏ß‡∏î
      {% if budget_over_count > 0 %}
        ¬∑ <span class="text-danger">‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö‡πÅ‡∏•‡πâ‡∏ß {{ budget_over_count }} ‡∏´‡∏°‡∏ß‡∏î</span>
      {% else %}
        ¬∑ <span class="text-success">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏´‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö</span>
      {% endif %}
    </div>

    {% if budget_items_dashboard %}
      <div class="d-flex flex-column gap-2">
        {% for it in budget_items_dashboard %}
          <div>
            <div class="d-flex justify-content-between align-items-center mb-1" style="font-size:13px;">
              <div class="fw-semibold">{{ it.category_name }}</div>
              <div class="text-secondary">
                ‡∏ø{{ it.spent|floatformat:0 }} / ‡∏ø{{ it.budget_amount|floatformat:0 }}
              </div>
            </div>

            {% if it.percent is not None %}
              <div style="width:100%;height:7px;border-radius:999px;background:#020617;overflow:hidden;border:1px solid rgba(148,163,184,.6);">
                {% with p=it.percent %}
                  <div style="
                    height:100%;
                    width:{% if p > 100 %}100{% else %}{{ p|floatformat:0 }}{% endif %}%;
                    {% if p < 70 %}
                      background:linear-gradient(to right,#22c55e,#4ade80);
                    {% elif p < 100 %}
                      background:linear-gradient(to right,#eab308,#f97316);
                    {% else %}
                      background:linear-gradient(to right,#ef4444,#b91c1c);
                    {% endif %}
                  "></div>
                {% endwith %}
              </div>
              <div class="d-flex justify-content-between mt-1" style="font-size:11px;">
                <span class="text-secondary">
                  ‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß {{ it.percent|floatformat:0 }}%
                </span>
                <span class="{% if it.diff < 0 %}text-danger{% else %}text-secondary{% endif %}">
                  ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ø{{ it.diff|floatformat:0 }}
                </span>
              </div>
            {% else %}
              <div class="text-secondary" style="font-size:11px;">
                ‡∏á‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0 ‡∏à‡∏∂‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-secondary" style="font-size:13px;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢
      </div>
    {% endif %}
  {% endif %}
</div>
{% endif %}

<!-- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏∂‡∏á -->
<div class="row g-3 mb-4">
  {% if not dash_pref or dash_pref.show_goals %}
  <div class="col-12 col-lg-6">
    <div class="card-soft-ghost p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="fw-semibold">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>
          <div class="text-secondary" style="font-size:12px;">
            ‡πÅ‡∏™‡∏î‡∏á 3 ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏£‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡πâ‡∏≤
          </div>
        </div>
        <a href="{% url 'app_finance:goals_list' %}" class="badge-chip">
          ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </a>
      </div>

      {% if goals_preview %}
        <div class="d-flex flex-column gap-2">
          {% for g in goals_preview %}
            <div>
              <div class="d-flex justify-content-between align-items-center mb-1" style="font-size:13px;">
                <div class="fw-semibold">{{ g.obj.name }}</div>
                <div class="text-secondary">
                  ‡∏ø{{ g.done|floatformat:0 }} / ‡∏ø{{ g.target|floatformat:0 }}
                </div>
              </div>
              {% if g.percent is not None %}
                <div style="width:100%;height:7px;border-radius:999px;background:#020617;overflow:hidden;border:1px solid rgba(148,163,184,.6);">
                  {% with p=g.percent %}
                    <div style="
                      height:100%;
                      width:{% if p > 100 %}100{% else %}{{ p|floatformat:0 }}{% endif %}%;
                      {% if p < 50 %}
                        background:linear-gradient(to right,#22c55e,#4ade80);
                      {% elif p < 100 %}
                        background:linear-gradient(to right,#eab308,#f97316);
                      {% else %}
                        background:linear-gradient(to right,#22c55e,#16a34a);
                      {% endif %}
                    "></div>
                  {% endwith %}
                </div>
                <div class="d-flex justify-content-between mt-1" style="font-size:11px;">
                  <span class="text-secondary">
                    ‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß {{ g.percent|floatformat:0 }}%
                  </span>
                  <span class="{% if g.remaining < 0 %}text-success{% else %}text-secondary{% endif %}">
                    ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ø{{ g.remaining|floatformat:0 }}
                  </span>
                </div>
              {% else %}
                <div class="text-secondary" style="font-size:11px;">
                  ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡∏¢
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-secondary" style="font-size:13px;">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡∏•‡∏≠‡∏á‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π ‚Äú‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‚Äù ‡∏î‡∏π‡∏Ñ‡∏±‡∏ö
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if not dash_pref or dash_pref.show_recurring %}
  <div class="col-12 col-lg-6">
    <div class="card-soft-ghost p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="fw-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á</div>
          <div class="text-secondary" style="font-size:12px;">
            ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
          </div>
        </div>
        <a href="{% url 'app_finance:recurring_list' %}" class="badge-chip">
          ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
        </a>
      </div>

      {% if upcoming_recurring %}
        <ul class="list-unstyled mb-0" style="font-size:13px;">
          {% for item in upcoming_recurring %}
            <li class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div class="fw-semibold">
                  {{ item.obj.name|default:item.obj.category.name|default:"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥" }}
                </div>
                <div class="text-secondary" style="font-size:11px;">
                  ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: {{ item.obj.account.name }}
                  {% if item.obj.category %}
                    ¬∑ ‡∏´‡∏°‡∏ß‡∏î: {{ item.obj.category.name }}
                  {% endif %}
                </div>
              </div>
              <div class="text-end">
                <div class="{% if item.obj.direction == 'OUT' %}text-danger{% else %}text-success{% endif %}">
                  {% if item.obj.direction == 'OUT' %}-{% endif %}
                  ‡∏ø{{ item.obj.amount|floatformat:0 }}
                </div>
                <div class="text-secondary" style="font-size:11px;">
                  {{ item.next_date|date:"d/m" }}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-secondary" style="font-size:13px;">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ recurring ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏õ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

{% if not dash_pref or dash_pref.show_today_summary %}
<!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -->
<div class="card-soft-ghost p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <div class="fw-semibold">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="text-secondary" style="font-size:12px;">
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ today|date:"d/m/Y" }}
      </div>
    </div>
    <span class="badge-chip">Today</span>
  </div>

  <div class="row g-3">
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="fw-semibold text-success" style="font-size:18px;">
        ‡∏ø{{ today_income|default_if_none:"0"|floatformat:2 }}
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="fw-semibold text-danger" style="font-size:18px;">
        ‡∏ø{{ today_expense|default_if_none:"0"|floatformat:2 }}
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="fw-semibold"
           style="font-size:18px;
             {% if today_net > 0 %}
               color:#22c55e;
             {% elif today_net < 0 %}
               color:#f97373;
             {% else %}
               color:#e5e7eb;
             {% endif %}
           ">
        ‡∏ø{{ today_net|default_if_none:"0"|floatformat:2 }}
      </div>
      {% if today_net < 0 %}
        <div class="text-secondary" style="font-size:11px;">
          ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡πÉ‡∏ô Dashboard ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏î‡∏π‡∏Ñ‡∏±‡∏ö
        </div>
      {% elif today_net > 0 %}
        <div class="text-secondary" style="font-size:11px;">
          ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏ö‡∏ß‡∏Å‡∏≠‡∏¢‡∏π‡πà ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏î‡∏î üíö
        </div>
      {% else %}
        <div class="text-secondary" style="font-size:11px;">
          ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏û‡∏≠‡∏î‡∏µ
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

{% if not dash_pref or dash_pref.show_trend_chart %}
<!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
<div class="card-soft-ghost p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <div class="fw-semibold">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      <div class="text-secondary" style="font-size:12px;">
        ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      </div>
    </div>
    <span class="badge-chip">Trend</span>
  </div>
  <div style="height:220px; max-height:220px;">
    <canvas id="incomeExpenseChart"></canvas>
  </div>
</div>
{% endif %}

{% if not dash_pref or dash_pref.show_expense_pie %}
<!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î -->
<div class="card-soft-ghost p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <div class="fw-semibold">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
      <div class="text-secondary" style="font-size:12px;">
        ‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏´‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
      </div>
    </div>
    <span class="badge-chip">Categories</span>
  </div>
  <div class="row g-3 align-items-center">
    <div class="col-12 col-md-6">
      <div style="height:220px; max-height:220px;">
        <canvas id="expenseByCategoryChart"></canvas>
      </div>
    </div>
    <div class="col-12 col-md-6">
      {% if cat_labels %}
        <div class="text-secondary" style="font-size:12px;">
          ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏∑‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        </div>
      {% else %}
        <div class="text-secondary" style="font-size:12px;">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏ö
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

{% if not dash_pref or dash_pref.show_estimate_box %}
<!-- ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ -->
<div class="card-soft-ghost p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <div class="fw-semibold">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="text-secondary" style="font-size:12px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‚Äù</div>
    </div>
    <span class="badge-chip">Estimate</span>
  </div>
  <div class="row g-3">
    <div class="col-4">
      <div class="text-secondary" style="font-size:12px;">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
      <div class="fw-semibold">‡∏ø{{ est_income|floatformat:2 }}</div>
    </div>
    <div class="col-4">
      <div class="text-secondary" style="font-size:12px;">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
      <div class="fw-semibold text-danger">‡∏ø{{ est_expense|floatformat:2 }}</div>
    </div>
    <div class="col-4">
      <div class="text-secondary" style="font-size:12px;">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
      <div class="fw-semibold {% if est_net < 0 %}text-danger{% else %}text-success{% endif %}">
        ‡∏ø{{ est_net|floatformat:2 }}
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if not dash_pref or dash_pref.show_debt_plan_card %}
<!-- ‡πÅ‡∏ú‡∏ô‡∏õ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà -->
<div class="card-soft-ghost p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-1">
    <div>
      <div class="fw-semibold">‡πÅ‡∏ú‡∏ô‡∏õ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="text-secondary" style="font-size:12px;">
        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡πÅ‡∏ú‡∏ô‡∏õ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î Dashboard
      </div>
    </div>
    <a href="{% url 'app_finance:debts_overview' %}" class="badge-chip">
      ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏õ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ
    </a>
  </div>

  {% if debt_plan %}
    {% if debt_plan.strategy == "SNOWBALL" %}
      <div style="font-size:13px;">
        <span class="fw-semibold">Snowball ‚Äì ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏Å‡πà‡∏≠‡∏ô</span><br>
        <span class="text-secondary" style="font-size:12px;">
          ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡πâ‡∏≠‡∏ô ‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πà‡∏≠‡∏¢ ‡∏°‡∏µ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏õ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏≤‡∏ß ‡πÜ
        </span>
      </div>
    {% elif debt_plan.strategy == "AVALANCHE" %}
      <div style="font-size:13px;">
        <span class="fw-semibold">Avalanche ‚Äì ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏π‡∏á‡∏Å‡πà‡∏≠‡∏ô</span><br>
        <span class="text-secondary" style="font-size:12px;">
          ‡∏à‡∏±‡∏î‡∏´‡∏ô‡∏±‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡∏•‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏à‡∏ô‡∏¥‡πà‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢
        </span>
      </div>
    {% else %}
      <div class="text-secondary" style="font-size:13px;">
        ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏ú‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏•‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Snowball ‡∏´‡∏£‡∏∑‡∏≠ Avalanche ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡πÅ‡∏ú‡∏ô‡∏õ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‚Äù ‡∏î‡∏π‡∏Ñ‡∏±‡∏ö
      </div>
    {% endif %}
  {% else %}
    <div class="text-secondary" style="font-size:13px;">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏õ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡πÅ‡∏ú‡∏ô‡∏õ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏±‡∏ö
    </div>
  {% endif %}
</div>
{% endif %}


<div class="row g-4">
  <!-- ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
  {% if not dash_pref or dash_pref.show_accounts %}
  <div class="col-12 col-lg-5">
    <div class="card-soft-ghost p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-semibold">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</div>
        <span class="badge-chip">{{ accounts|length }} ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
      </div>
      {% if accounts %}
        <div class="list-group list-group-flush">
          {% for acc in accounts %}
            <div class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between align-items-center py-2">
              <div>
                <div class="fw-semibold">{{ acc.name }}</div>
                <div class="text-secondary" style="font-size:11px;">
                  {{ acc.get_account_type_display }}
                </div>
              </div>
              <div class="text-end">
                {% if acc.current_balance < 0 %}
                  <div class="text-danger">‡∏ø{{ acc.current_balance|floatformat:2 }}</div>
                  <div class="text-secondary" style="font-size:11px;">(‡∏´‡∏ô‡∏µ‡πâ)</div>
                {% else %}
                  <div class="text-success">‡∏ø{{ acc.current_balance|floatformat:2 }}</div>
                  <div class="text-secondary" style="font-size:11px;">(‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-secondary" style="font-size:13px;">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏•‡∏¢ ‡∏•‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π ‚Äú‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if not dash_pref or dash_pref.show_recent_transactions %}
  <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
  <div class="col-12 col-lg-7">
    <div class="card-soft-ghost p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div class="d-flex gap-2">
          <a href="{% url 'app_finance:transactions_list' %}" class="btn btn-ghost btn-sm">
            ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </a>
          <a href="{% url 'app_finance:transaction_create' %}" class="btn btn-brand btn-sm">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </a>
        </div>
      </div>

      {% if recent_tx %}
        <div class="table-responsive">
          <table class="table table-dark table-sm align-middle mb-0" style="font-size:13px;">
            <thead>
              <tr class="text-secondary">
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th>‡∏´‡∏°‡∏ß‡∏î</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody>
              {% for t in recent_tx %}
                <tr>
                  <td>{{ t.date|date:"d/m" }}</td>
                  <td>{{ t.account.name }}</td>
                  <td>
                    {% if t.direction == 'IN' %}
                      <span class="badge-chip">‡πÄ‡∏Ç‡πâ‡∏≤</span>
                    {% else %}
                      <span class="badge-chip">‡∏≠‡∏≠‡∏Å</span>
                    {% endif %}
                  </td>
                  <td class="text-end {% if t.direction == 'OUT' %}text-danger{% else %}text-success{% endif %}">
                    {% if t.direction == 'OUT' %}-{% endif %}
                    ‡∏ø{{ t.amount|floatformat:2 }}
                  </td>
                  <td>{{ t.category.name|default:"-" }}</td>
                  <td>
                    {% if t.is_estimate %}
                      <span class="badge-chip">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</span>
                    {% else %}
                      <span class="badge-chip">‡∏à‡∏£‡∏¥‡∏á</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-secondary" style="font-size:13px;">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏•‡∏≠‡∏á‡∏Å‡∏î ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏î‡∏π‡∏Ñ‡∏±‡∏ö
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Quick Add Transaction Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1" aria-labelledby="quickAddModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background:#020617;border-radius:18px;border:1px solid #1f2937;">
      <div class="modal-header">
        <h5 class="modal-title" id="quickAddModalLabel">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'app_finance:transaction_create' %}?next={{ request.path }}">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.path }}">

          <!-- Template -->
          <div class="mb-2">
            <label class="form-label" style="font-size:12px;">‡πÉ‡∏ä‡πâ Template</label>
            <select id="quickTemplateSelect" class="form-select form-select-sm">
              <option value="">-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Template --</option>
              {% for t in quick_templates %}
                <option value="{{ t.id }}"
                        data-direction="{{ t.direction }}"
                        data-amount="{{ t.default_amount|default_if_none:'' }}"
                        data-account="{{ t.account_id|default_if_none:'' }}"
                        data-category="{{ t.category_id|default_if_none:'' }}"
                        data-note="{{ t.note|default_if_none:'' }}"
                        data-tags="{% for tag in t.tags.all %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                  {{ t.name }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text" style="font-size:11px;">
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Template ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ö‡∏î‡πà‡∏ß‡∏ô ‡πÜ (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
            </div>
          </div>

          <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
          <div class="mb-2">
            <label class="form-label" style="font-size:12px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" name="date" class="form-control form-control-sm"
                   value="{{ today|date:'Y-m-d' }}">
          </div>

          <!-- ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ -->
          <div class="mb-2">
            <label class="form-label" style="font-size:12px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="direction" id="quickDirOut" value="OUT" checked>
                <label class="form-check-label" for="quickDirOut">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="direction" id="quickDirIn" value="IN">
                <label class="form-check-label" for="quickDirIn">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</label>
              </div>
            </div>
          </div>

          <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
          <div class="mb-2">
            <label class="form-label" style="font-size:12px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
            <input type="number" step="0.01" name="amount" id="quickAmount"
                   class="form-control form-control-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 120.00">
          </div>

          <!-- ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
          <div class="mb-2">
            <label class="form-label" style="font-size:12px;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <select name="account" id="quickAccount" class="form-select form-select-sm">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>
              {% for acc in accounts %}
                <option value="{{ acc.id }}">{{ acc.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- ‡∏´‡∏°‡∏ß‡∏î -->
          <div class="mb-2">
            <label class="form-label" style="font-size:12px;">‡∏´‡∏°‡∏ß‡∏î</label>
            <select name="category" id="quickCategory" class="form-select form-select-sm">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î --</option>
              {% for c in all_categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Tag -->
          <div class="mb-2">
            <label class="form-label" style="font-size:12px;">Tag</label>
            <select name="tags" id="quickTags" class="form-select form-select-sm" multiple>
              {% for tag in all_tags %}
                <option value="{{ tag.id }}">{{ tag.name }}</option>
              {% endfor %}
            </select>
            <div class="form-text" style="font-size:11px;">
              ‡∏Å‡∏î Ctrl/Command ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢ Tag
            </div>
          </div>

          <!-- note -->
          <div class="mb-2">
            <label class="form-label" style="font-size:12px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <input type="text" name="note" id="quickNote"
                   class="form-control form-control-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">
          </div>

          <!-- ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏° TransactionForm ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£, ‡πÄ‡∏ä‡πà‡∏ô is_estimate -->
          <input type="hidden" name="is_estimate" value="0">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button type="submit" class="btn btn-brand btn-sm">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function() {
      // ===== ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î =====
      const lineCanvas = document.getElementById('incomeExpenseChart');
      if (lineCanvas) {
        const labels = {{ chart_labels|safe }};
        const incomeData = {{ chart_income|safe }};
        const expenseData = {{ chart_expense|safe }};

        new Chart(lineCanvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',
                data: incomeData,
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 3,
                borderColor: 'rgba(34,197,94,1)',
                backgroundColor: 'rgba(34,197,94,0.15)',
                fill: true,
              },
              {
                label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
                data: expenseData,
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 3,
                borderColor: 'rgba(248,113,113,1)',
                backgroundColor: 'rgba(248,113,113,0.15)',
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                }
              },
            },
            scales: {
              x: {
                ticks: { color: '#9ca3af', font: { size: 11 } },
                grid: { color: 'rgba(30,41,59,0.6)' }
              },
              y: {
                ticks: { color: '#9ca3af', font: { size: 11 } },
                grid: { color: 'rgba(30,41,59,0.6)' }
              },
            },
          },
        });
      }

      // ===== ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î =====
      const pieCanvas = document.getElementById('expenseByCategoryChart');
        if (pieCanvas) {
          const catLabels = {{ cat_labels|safe }};
          const catValues = {{ cat_values|safe }};

          if (catLabels.length > 0 && catValues.length > 0) {
            const totalExpense = catValues.reduce((sum, v) => sum + v, 0);

            // ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÅ‡∏ö‡∏ö‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡πÄ‡∏Ç‡πâ‡∏° ‡πÜ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á
            const colors = [
              'rgba(45,212,191,0.9)',  // teal
              'rgba(56,189,248,0.9)',  // sky
              'rgba(251,146,60,0.9)',  // orange
              'rgba(244,114,182,0.9)', // pink
              'rgba(129,140,248,0.9)', // indigo
              'rgba(190,242,100,0.9)', // lime
              'rgba(248,250,252,0.9)', // soft
              'rgba(248,113,113,0.9)', // red
            ];

            const bgColors = catValues.map((_, idx) => colors[idx % colors.length]);

            const centerTextPlugin = {
              id: 'centerText',
              afterDraw(chart, args, options) {
                const { ctx, chartArea: { left, right, top, bottom } } = chart;
                const x = (left + right) / 2;
                const y = (top + bottom) / 2;

                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏ß‡∏°
                ctx.fillStyle = '#e5e7eb';
                ctx.font = '600 15px "Prompt", system-ui';
                const formatted = totalExpense.toLocaleString(undefined, {
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 0,
                });
                ctx.fillText(`‡∏ø${formatted}`, x, y - 6);

                // label ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                ctx.fillStyle = '#9ca3af';
                ctx.font = '400 11px "Prompt", system-ui';
                ctx.fillText('‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ', x, y + 10);

                ctx.restore();
              }
            };

            new Chart(pieCanvas, {
              type: 'doughnut',
              data: {
                labels: catLabels,
                datasets: [{
                  data: catValues,
                  backgroundColor: bgColors,
                  borderColor: '#020617',
                  borderWidth: 2,
                  hoverOffset: 6,
                  spacing: 2,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',   // ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏î‡∏ô‡∏±‡∏ó‡∏™‡∏ß‡∏¢ ‡πÜ
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      color: '#e5e7eb',
                      font: { size: 11 },
                      // ‡∏ï‡∏±‡∏î label ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô
                      generateLabels(chart) {
                        const original = Chart.overrides.doughnut.plugins.legend.labels.generateLabels(chart);
                        return original.map(item => {
                          const maxLen = 18;
                          if (item.text.length > maxLen) {
                            item.text = item.text.slice(0, maxLen) + '‚Ä¶';
                          }
                          return item;
                        });
                      }
                    }
                  },
                  tooltip: {
                    backgroundColor: 'rgba(15,23,42,0.95)',
                    borderColor: 'rgba(148,163,184,0.7)',
                    borderWidth: 1,
                    padding: 8,
                    titleFont: { size: 12, family: 'Prompt' },
                    bodyFont: { size: 11, family: 'Prompt' },
                    callbacks: {
                      label(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const percent = totalExpense
                          ? (value / totalExpense * 100).toFixed(1)
                          : 0;

                        const valueStr = value.toLocaleString(undefined, {
                          minimumFractionDigits: 0,
                          maximumFractionDigits: 0,
                        });
                        return `${label}: ‡∏ø${valueStr} (${percent}%)`;
                      }
                    }
                  }
                }
              },
              plugins: [centerTextPlugin],
            });
          }
        }

      // ===== Quick Add Template Autofill =====
      (function(){
        const tplSelect = document.getElementById("quickTemplateSelect");
        if (!tplSelect) return;

        const amountInput = document.getElementById("quickAmount");
        const accountSelect = document.getElementById("quickAccount");
        const categorySelect = document.getElementById("quickCategory");
        const noteInput = document.getElementById("quickNote");
        const tagSelect = document.getElementById("quickTags");
        const dirOut = document.getElementById("quickDirOut");
        const dirIn = document.getElementById("quickDirIn");

        tplSelect.addEventListener("change", function(){
          const opt = tplSelect.options[tplSelect.selectedIndex];
          if (!opt || !opt.value) {
            return;
          }
          const dir = opt.getAttribute("data-direction");
          const amt = opt.getAttribute("data-amount");
          const accId = opt.getAttribute("data-account");
          const catId = opt.getAttribute("data-category");
          const note = opt.getAttribute("data-note");
          const tags = opt.getAttribute("data-tags") || "";

          if (dir === "IN") {
            dirIn.checked = true;
          } else {
            dirOut.checked = true;
          }
          if (amt && amountInput) amountInput.value = amt;
          if (noteInput) noteInput.value = note || "";

          if (accountSelect) {
            for (const o of accountSelect.options) {
              o.selected = (accId && o.value === accId);
            }
          }
          if (categorySelect) {
            for (const o of categorySelect.options) {
              o.selected = (catId && o.value === catId);
            }
          }
          if (tagSelect) {
            const tagIds = tags ? tags.split(",") : [];
            for (const o of tagSelect.options) {
              o.selected = tagIds.includes(o.value);
            }
          }
        });
      })();

      // ===== Keyboard shortcut: Shift + A ‡πÄ‡∏õ‡∏¥‡∏î Quick Add =====
      document.addEventListener("keydown", function(e){
        const target = e.target;
        if (target && (target.tagName === "INPUT" || target.tagName === "TEXTAREA" || target.tagName === "SELECT")) {
          return;
        }
        if ((e.key === "A" || e.key === "a") && e.shiftKey) {
          const modalEl = document.getElementById("quickAddModal");
          if (!modalEl || typeof bootstrap === "undefined") return;
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        }
      });

    })();
  </script>
{% endblock %}
