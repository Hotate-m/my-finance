{% extends "app_finance/base.html" %}

{% block title %}แผนปลดหนี้{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
  <div>
    <h1 class="h3 mb-1">แผนปลดหนี้</h1>
    <div class="text-secondary" style="font-size:13px;">
      รวมยอดหนี้จากบัญชีประเภทบัตรเครดิตและเงินกู้ · ตั้งเป้าปลดหนี้ให้จบภายใน X เดือน
    </div>
  </div>
  <div class="text-secondary" style="font-size:11px;">
    อัปเดตล่าสุด: {{ today|date:"d/m/Y" }}
  </div>
</div>

<div class="card-soft p-3 mb-3">
  <form method="get" class="row g-2 align-items-end">
    <div class="col-12 col-md-4">
      <label class="form-label" style="font-size:12px;">
        อยากปลดหนี้ให้หมดภายใน (เดือน)
      </label>
      <input type="number" name="months"
             class="form-control form-control-sm"
             min="1"
             placeholder="เช่น 24"
             value="{{ months_input }}">
    </div>
    <div class="col-12 col-md-2">
      <button type="submit" class="btn btn-brand btn-sm w-100">
        คำนวณแผนปลดหนี้
      </button>
    </div>
    <div class="col-12 col-md-6 text-secondary" style="font-size:12px;">
      ใส่จำนวนเดือนที่อยากให้หนี้ทุกก้อนหมด (เช่น 24 เดือน) ระบบจะประมาณยอดที่ควรจ่ายต่อเดือนของแต่ละบัญชี
    </div>
  </form>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-md-4">
    <div class="card-soft p-3 h-100">
      <div class="text-secondary" style="font-size:12px;">ยอดหนี้รวมทั้งหมด</div>
      <div class="fw-semibold text-danger" style="font-size:20px;">
        ฿{{ total_debt|floatformat:2 }}
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card-soft-ghost p-3 h-100">
      <div class="text-secondary" style="font-size:12px;">ดอกเบี้ยต่อเดือน (ประมาณการ)</div>
      <div class="fw-semibold text-warning" style="font-size:18px;">
        ฿{{ total_monthly_interest|floatformat:2 }}
      </div>
      <div class="text-secondary" style="font-size:11px;">
        คำนวณจากดอกเบี้ยต่อปีของแต่ละบัญชี หาร 12 (ไม่รวมลดต้นลดดอกจริง)
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card-soft-ghost p-3 h-100">
      <div class="text-secondary" style="font-size:12px;">ยอดจ่ายขั้นต่ำรวม</div>
      <div class="fw-semibold" style="font-size:18px;">
        ฿{{ total_min_payment|floatformat:2 }}
      </div>
      <div class="text-secondary" style="font-size:11px;">
        รวมเฉพาะบัญชีที่ตั้งเปอร์เซ็นต์จ่ายขั้นต่ำไว้
      </div>
    </div>
  </div>
</div>

<div class="card-soft-ghost p-3">
  <div class="fw-semibold mb-2">รายละเอียดหนี้รายบัญชี</div>
  {% if not debt_rows %}
    <div class="text-secondary" style="font-size:13px;">
      ตอนนี้ไม่มีบัญชีประเภทบัตรเครดิตหรือเงินกู้ที่มียอดหนี้ค้างอยู่
    </div>
  {% else %}
    <div class="table-responsive" style="font-size:12px;">
      <table class="table table-dark table-sm align-middle mb-0">
        <thead>
          <tr class="text-secondary">
            <th>บัญชี</th>
            <th>ประเภท</th>
            <th class="text-end">ยอดหนี้</th>
            <th class="text-end">ดอกเบี้ย/ปี</th>
            <th class="text-end">ดอกเบี้ย/เดือน</th>
            <th class="text-end">จ่ายขั้นต่ำ</th>
            <th class="text-end">วงเงิน / Utilization</th>
            {% if payoff_target_months %}
              <th class="text-end">แนะนำจ่าย/เดือน ({{ payoff_target_months }} เดือน)</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in debt_rows %}
            <tr>
              <td>{{ row.account.name }}</td>
              <td>
                {% if row.account.account_type == "CREDIT" %}
                  บัตรเครดิต
                {% elif row.account.account_type == "LOAN" %}
                  เงินกู้
                {% else %}
                  {{ row.account.account_type }}
                {% endif %}
              </td>
              <td class="text-end text-danger">฿{{ row.debt_amount|floatformat:2 }}</td>
              <td class="text-end">
                {% if row.interest_rate %}
                  {{ row.interest_rate|floatformat:2 }}%
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-end">
                {% if row.monthly_interest %}
                  ฿{{ row.monthly_interest|floatformat:2 }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-end">
                {% if row.min_payment %}
                  ฿{{ row.min_payment|floatformat:2 }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-end">
                {% if row.credit_limit %}
                  <div>วงเงิน ฿{{ row.credit_limit|floatformat:0 }}</div>
                  {% if row.utilization is not None %}
                    <div class="text-secondary" style="font-size:11px;">
                      ใช้ไปประมาณ {{ row.utilization|floatformat:0 }}%
                    </div>
                  {% endif %}
                {% else %}
                  -
                {% endif %}
              </td>
              {% if payoff_target_months %}
                <td class="text-end">
                  {% if row.payoff_per_month %}
                    <div class="fw-semibold text-success">
                      ฿{{ row.payoff_per_month|floatformat:2 }}
                    </div>
                    <div class="text-secondary" style="font-size:11px;">
                      (ถ้าจ่ายเท่านี้ทุกเดือน หนี้ก้อนนี้จะหมดราว {{ payoff_target_months }} เดือน
                      โดยยังไม่คิดดอกเบี้ยจริง)
                    </div>
                  {% else %}
                    -
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
{% endblock %}
