{% extends "app_finance/base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î{% endblock %}

{% block content %}
<div class="mb-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
  <div>
    <h1 class="h3 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>
    <div class="text-secondary" style="font-size:13px;">
      {% if selected_date %}
        ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ selected_date|date:"d/m/Y" }}
        ¬∑ <a href="{% url 'app_finance:transactions_list' %}" style="color:#a5b4fc;text-decoration:none;">
            ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
          </a>
      {% else %}
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
      {% endif %}
    </div>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a href="{% url 'app_finance:transaction_create' %}?type=IN" class="btn btn-brand btn-sm">
      + ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
    </a>
    <a href="{% url 'app_finance:transaction_create' %}?type=OUT" class="btn btn-ghost btn-sm">
      + ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
    </a>
  </div>
</div>

<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° filter -->
<div class="card-soft p-3 mb-3">
  <form method="get" class="row g-2 align-items-end">
    <div class="col-6 col-md-2">
      <label class="form-label" style="font-size:12px;">‡∏õ‡∏µ</label>
      <select name="year" class="form-select form-select-sm">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        {% for y in years %}
          <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label" style="font-size:12px;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
      <select name="month" class="form-select form-select-sm">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        {% for m, label in months %}
          <option value="{{ m }}" {% if month == m %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label" style="font-size:12px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select name="type" class="form-select form-select-sm">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="IN" {% if filter_type == "IN" %}selected{% endif %}>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
        <option value="OUT" {% if filter_type == "OUT" %}selected{% endif %}>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
      </select>
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label" style="font-size:12px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (note / ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡∏´‡∏°‡∏ß‡∏î)</label>
      <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm"
             placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, KBank, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô">
    </div>
    <div class="col-12 col-md-2 d-flex gap-2">
      <button type="submit" class="btn btn-brand btn-sm flex-fill">‡∏Å‡∏£‡∏≠‡∏á</button>
      <a href="{% url 'app_finance:transactions_list' %}" class="btn btn-ghost btn-sm flex-fill">
        ‡∏•‡πâ‡∏≤‡∏á
      </a>
    </div>
  </form>
</div>

<!-- ‡∏™‡∏£‡∏∏‡∏õ + ‡∏õ‡∏∏‡πà‡∏° Export -->
<div class="card-soft-ghost p-3 mb-3">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
    <div class="d-flex flex-column">
      <span class="fw-semibold" style="font-size:13px;">‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
      <span class="text-secondary" style="font-size:11px;">
        ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export CSV ‡πÑ‡∏õ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Excel ‡∏´‡∏£‡∏∑‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ
      </span>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'app_finance:transactions_export_csv' %}{% if query_string %}?{{ query_string }}{% endif %}"
         class="btn btn-ghost btn-sm">
        Export CSV
      </a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
      <div class="fw-semibold text-success">‡∏ø{{ income_sum|floatformat:2 }}</div>
    </div>
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
      <div class="fw-semibold text-danger">‡∏ø{{ expense_sum|floatformat:2 }}</div>
    </div>
    <div class="col-12 col-md-4">
      <div class="text-secondary" style="font-size:12px;">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
      <div class="fw-semibold {% if net_sum < 0 %}text-danger{% else %}text-success{% endif %}">
        ‡∏ø{{ net_sum|floatformat:2 }}
      </div>
    </div>
  </div>
</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
<div class="card-soft-ghost p-3">
  {% if transactions %}
    <div class="table-responsive">
      <table class="table table-dark table-sm align-middle mb-0" style="font-size:13px;">
        <thead>
          <tr class="text-secondary">
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th>‡∏´‡∏°‡∏ß‡∏î</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th class="text-center">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
            <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
            <tr class="click-row"
                data-href="{% url 'app_finance:transaction_edit' t.id %}">
              <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
              <td>{{ t.date|date:"d/m/Y" }}</td>

              <!-- ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
              <td>{{ t.account.name }}</td>

              <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏≠‡∏≠‡∏Å) -->
              <td>
                {% if t.direction == 'IN' %}
                  <span class="badge-chip">‡πÄ‡∏Ç‡πâ‡∏≤</span>
                {% else %}
                  <span class="badge-chip">‡∏≠‡∏≠‡∏Å</span>
                {% endif %}
              </td>

              <!-- ‡∏´‡∏°‡∏ß‡∏î -->
              <td>{{ t.category.name|default:"-" }}</td>

              <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏à‡∏£‡∏¥‡∏á / ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£) -->
              <td>
                {% if t.is_estimate %}
                  <span class="badge-chip">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</span>
                {% else %}
                  <span class="badge-chip">‡∏à‡∏£‡∏¥‡∏á</span>
                {% endif %}
              </td>

              <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
              <td>{{ t.note|default:"-" }}</td>

              <!-- ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô -->
              <td class="text-center">
                {% if t.proof_file %}
                  <a href="{{ t.proof_file.url }}" target="_blank" title="‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
                    üßæ
                  </a>
                {% else %}
                  <span class="text-secondary" style="font-size:11px;">-</span>
                {% endif %}
              </td>

              <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
              <td class="text-end {% if t.direction == 'OUT' %}text-danger{% else %}text-success{% endif %}">
                {% if t.direction == 'OUT' %}-{% endif %}
                ‡∏ø{{ t.amount|floatformat:2 }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="text-secondary" style="font-size:13px;">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢ ‡∏•‡∏≠‡∏á‡∏Å‡∏î ‚Äú+ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú+ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏î‡∏π‡∏Ñ‡∏±‡∏ö
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    // ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå/‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô
    document.querySelectorAll("tr.click-row").forEach(function(row){
      row.style.cursor = "pointer";
      row.addEventListener("click", function(e){
        if (e.target.closest("a, button, input, label")) {
          return; // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡πÑ‡∏õ
        }
        const url = row.getAttribute("data-href");
        if (url){
          window.location.href = url;
        }
      });
    });
  </script>
{% endblock %}
