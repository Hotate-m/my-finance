{% extends "app_finance/base.html" %}

{% block title %}บัญชี / กระเป๋า{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between align-items-center">
  <div>
    <h1 class="h3 mb-1">บัญชี / กระเป๋า</h1>
    <div class="text-secondary" style="font-size:13px;">
      จัดการกระเป๋าเงินสด, บัญชีธนาคาร, บัตรเครดิต, เงินกู้
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- ฟอร์มเพิ่มบัญชี -->
  <div class="col-12 col-lg-5">
    <div class="card-soft p-3">
      <h2 class="h6 mb-3">เพิ่มบัญชีใหม่</h2>
      <form method="post">
        {% csrf_token %}

        <!-- ชื่อบัญชี -->
        <div class="mb-2">
          <label class="form-label">ชื่อบัญชี / กระเป๋า</label>
          {{ form.name }}
        </div>

        <!-- ประเภท -->
        <div class="mb-2">
          <label class="form-label">ประเภท</label>
          {{ form.account_type }}
          <div class="form-text text-secondary" style="font-size:11px;">
            ถ้าเป็นบัตรเครดิตหรือเงินกู้ ระบบจะให้กรอกดอกเบี้ยและเปอร์เซ็นต์ขั้นต่ำเพิ่ม
          </div>
        </div>

        <!-- ฟิลด์เฉพาะตอนเป็น CREDIT / LOAN -->
        <div id="debt-extra-fields" class="mb-2" style="display:none;">
          <div class="row g-2">
            <!-- ดอกเบี้ยต่อปี -->
            <div class="col-12 col-md-6">
              <label class="form-label">
                ดอกเบี้ยต่อปี (Interest rate %)
              </label>
              {{ form.interest_rate }}
              <div class="form-text text-secondary" style="font-size:11px;">
                ใส่เป็นเปอร์เซ็นต์ต่อปี เช่น 16, 18<br>
                ถ้าไม่ทราบสามารถเว้นว่างไว้ได้
              </div>
            </div>

            <!-- เปอร์เซ็นต์ขั้นต่ำ -->
            <div class="col-12 col-md-6">
              <label class="form-label">
                เปอร์เซ็นต์ยอดชำระขั้นต่ำต่อรอบบิล (Min payment %)
              </label>
              {{ form.min_payment_percent }}
              <div class="form-text text-secondary" style="font-size:11px;">
                เช่น ขั้นต่ำ 10% ของยอดหนี้ ให้ใส่ 10<br>
                ใช้คำนวณ “เดือนโดยประมาณ” ในหน้าแผนปลดหนี้
              </div>
            </div>
          </div>
        </div>

        <!-- ยอดตั้งต้น -->
        <div class="mb-2">
          <label class="form-label">ยอดตั้งต้น (Opening balance)</label>
          {{ form.opening_balance }}
          <div class="form-text text-secondary" style="font-size:11px;">
            ถ้าเป็นหนี้ เช่น เงินกู้เริ่มต้น 300,000 ให้ใส่ -300000
          </div>
        </div>

        <!-- วงเงิน -->
        <div class="mb-2">
          <label class="form-label">วงเงิน (Credit limit) ถ้ามี</label>
          {{ form.credit_limit }}
        </div>

        <!-- ใช้งานอยู่ -->
        <div class="form-check mb-3">
          {{ form.is_active }}
          <label class="form-check-label">ใช้งานอยู่</label>
        </div>

        <button type="submit" class="btn btn-brand w-100">
          บันทึกบัญชีใหม่
        </button>
      </form>
    </div>
  </div>

  <!-- รายการบัญชี -->
  <div class="col-12 col-lg-7">
    <div class="card-soft p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 mb-0">รายการบัญชีทั้งหมด</h2>
        <span class="badge-chip bg-light text-dark">{{ accounts|length }} บัญชี</span>
      </div>

      {% if accounts %}
        {# ===== Desktop / Tablet: แสดงแบบตาราง ===== #}
        <div class="d-none d-md-block">
          <div class="table-responsive">
            <table class="table table-dark table-sm align-middle mb-0" style="font-size:13px;">
              <thead>
                <tr class="text-secondary">
                  <th>ชื่อ</th>
                  <th>ประเภท</th>
                  <th class="text-end">ยอดตั้งต้น</th>
                  <th class="text-end">ยอดปัจจุบัน</th>
                  <th class="text-end">วงเงิน</th>
                  <th>สถานะ</th>
                </tr>
              </thead>
              <tbody>
                {% for acc in accounts %}
                  <tr>
                    <td>
                      <a href="{% url 'app_finance:account_edit' acc.id %}"
                         style="color:inherit; text-decoration:underline dotted; text-underline-offset: 2px;">
                        {{ acc.name }}
                      </a>
                    </td>
                    <td>{{ acc.get_account_type_display }}</td>
                    <td class="text-end">
                      ฿{{ acc.opening_balance|floatformat:2 }}
                    </td>
                    <td class="text-end {% if acc.current_balance < 0 %}text-danger{% else %}text-success{% endif %}">
                      ฿{{ acc.current_balance|floatformat:2 }}
                    </td>
                    <td class="text-end">
                      {% if acc.credit_limit %}
                        ฿{{ acc.credit_limit|floatformat:2 }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if acc.is_active %}
                        <span class="badge-chip bg-success-subtle text-success">ใช้งาน</span>
                      {% else %}
                        <span class="badge-chip bg-secondary">ปิดใช้งาน</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        {# ===== Mobile: แสดงเป็นการ์ด ===== #}
        <div class="d-block d-md-none">
          <div class="d-flex flex-column gap-2">
            {% for acc in accounts %}
              <a href="{% url 'app_finance:account_edit' acc.id %}"
                 class="card-soft-ghost p-2"
                 style="display:block; color:inherit;">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <div>
                    <div class="fw-semibold" style="font-size:13px;">
                      {{ acc.name }}
                    </div>
                    <div class="text-secondary" style="font-size:11px;">
                      {{ acc.get_account_type_display }}
                    </div>
                  </div>
                  <div class="text-end" style="font-size:12px;">
                    <div class="{% if acc.current_balance < 0 %}text-danger{% else %}text-success{% endif %}">
                      ฿{{ acc.current_balance|floatformat:2 }}
                    </div>
                    {% if acc.credit_limit %}
                      <div class="text-secondary" style="font-size:10px;">
                        วงเงิน ฿{{ acc.credit_limit|floatformat:0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
                <div class="d-flex justify-content-between align-items-center" style="font-size:10px;">
                  <div class="text-secondary">
                    เปิดต้นทาง ฿{{ acc.opening_balance|floatformat:0 }}
                  </div>
                  <div>
                    {% if acc.is_active %}
                      <span class="badge-chip" style="font-size:10px;">ใช้งาน</span>
                    {% else %}
                      <span class="badge-chip" style="font-size:10px;">ปิดใช้งาน</span>
                    {% endif %}
                  </div>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="text-secondary" style="font-size:13px;">
          ยังไม่มีบัญชีเลย ลองเพิ่มจากฟอร์มด้านซ้ายได้เลยคับ
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  /* บีบความกว้างช่องดอกเบี้ย + min payment ไม่ให้ยาวเกินไป */
  #id_interest_rate,
  #id_min_payment_percent {
    max-width: 150px;  /* จะปรับเป็น 100 / 140 ก็ได้ตามใจ */
  }
</style>

<!-- JS: แสดงฟิลด์ดอกเบี้ย/ขั้นต่ำเฉพาะตอนเลือก CREDIT หรือ LOAN -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    function toggleDebtFields() {
      const select = document.getElementById('id_account_type');
      const extra = document.getElementById('debt-extra-fields');
      if (!select || !extra) return;

      const v = select.value;
      if (v === 'CREDIT' || v === 'LOAN') {
        extra.style.display = 'block';
      } else {
        extra.style.display = 'none';
        const ir = document.getElementById('id_interest_rate');
        const mp = document.getElementById('id_min_payment_percent');
        if (ir) ir.value = '';
        if (mp) mp.value = '';
      }
    }

    toggleDebtFields();  // ตอนโหลดหน้า
    const select = document.getElementById('id_account_type');
    if (select) {
      select.addEventListener('change', toggleDebtFields);
    }
  });
</script>
{% endblock %}
